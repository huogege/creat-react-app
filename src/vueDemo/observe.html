<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        // 源码位置：src/core/observer/index.js

        /**
         * Observer类会通过递归的方式把一个对象的所有属性都转化成可观测对象
         */
        class Observer {
            constructor(value) {
                this.value = value
                // 给value新增一个__ob__属性，值为该value的Observer实例
                // 相当于为value打上标记，表示它已经被转化成响应式了，避免重复操作

                if (Array.isArray(value)) {
                    // 当value为数组时的逻辑
                    // ...
                } else {
                    this.walk(value)
                }
            }

            walk(obj) {
                const keys = Object.keys(obj)
                for (let i = 0; i < keys.length; i++) {
                    defineReactive(obj, keys[i])
                }
            }
        }
        /**
         * 使一个对象转化成可观测对象
         * @param { Object } obj 对象
         * @param { String } key 对象的key
         * @param { Any } val 对象的某个key的值
         */
        function defineReactive(obj, key, val) {
            // 如果只传了obj和key，那么val = obj[key]
            if (arguments.length === 2) {
                val = obj[key]
            }
            if (typeof val === 'object') {
                new Observer(val)
            }
            const dep = new Dep()    //实例化一个依赖收集器
            Object.defineProperty(obj, key, {
                enumerable: true,
                configurable: true,
                get() {
                    console.log(`${key}属性被读取了`);
                    dep.depend()
                    return val;
                },
                set(newVal) {
                    if (val === newVal) {
                        return
                    }
                    console.log(`${key}属性被修改了`);
                    dep.notify()
                    val = newVal;
                }
            })
        }

        function remove(arr, item) {
            const index = arr.indexOf(item)
            if (index > -1) {
                return arr.splice(index, 1)
            }
        }
        class Dep {
            constructor() {
                this.subs = []
            }
            addSub(sub) {
                this.subs.push(sub)
            }
            removeSub(sub) {
                remove(this.subs, sub)
            }
            //新增一个依赖
            depend() {
                if (window.target) {
                    this.addSub(window.target)
                }
            }
            //更新一个依赖
            notify() {
                const subs = this.subs.slice()   // deep clone
                for (let i = 0; i < subs.length; i++) {
                    subs[i].update()
                }
            }
        }

        class Watcher {
            constructor(vm, expOrFn, cb) {
                this.vm = vm
                this.expOrFn = expOrFn
                this.cb = cb
                this.getter = parsePath(expOrFn)
                this.value = this.get()
            }
            get() {
                window.target = this
                const vm = this.vm
                let value = this.getter.call(vm, vm)
                window.target = undefined;
                return value
            }
            update() {
                const oldValue = this.value
                this.value = this.get()
                this.cb.call(this.vm, this.value, oldValue)
            }
        }
        function parsePath(path) {
            const bailRE = /[^\w.$]/
            if (bailRE.test(path)) {
                return
            }
            const segments = path.split('.')
            return function (obj) {
                for (let i = 0; i < segments.length; i++) {
                    if (!obj) return
                    obj = obj[segments[i]]
                }
                return obj
            }
        }

        class Vue{
            constructor(data) {
                this._data = data
                new Observer(this._data)
                new Watcher({},'price')
                console.log('ready to render')
            }
        }

        let car = new Vue({
            'brand': 'BMW',
            'price': 3000
        })
        console.log(car)
    </script>
</body>

</html>